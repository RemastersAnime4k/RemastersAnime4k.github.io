<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Remastersanime4k</title>
  <meta name="description" content="Remastersanime4k - Tu fuente principal de anime remasterizado en 4K, mangas y más" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="preconnect" href="https://api.fontshare.com" crossorigin />
  <link rel="stylesheet" href="https://api.fontshare.com/css?f[]=satoshi@400,500,700&display=swap" />
  <style>
    :root {
      --primary-color: #ff6b6b;
      --glass-bg: rgba(255, 255, 255, 0.08);
      --color1: #ffcccc; --color2: #ccffff; --color3: #ffd9cc; --color4: #ccfffc;
      --text-color: #2d3436;
      --card-border: rgba(255, 255, 255, 0.18);
      --shadow-light: rgba(0, 0, 0, 0.12);
      --shadow-hover: rgba(0, 0, 0, 0.2);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --color1: #1a0a0a; --color2: #0a1a1a; --color3: #1a120a; --color4: #0a1a18;
        --glass-bg: rgba(20, 20, 30, 0.3);
        --text-color: #f0f0f0;
        --card-border: rgba(255, 255, 255, 0.1);
        --shadow-light: rgba(0, 0, 0, 0.4);
        --shadow-hover: rgba(0, 0, 0, 0.5);
      }
    }

    body {
      background: linear-gradient(135deg, var(--color1), var(--color2), var(--color3), var(--color4));
      background-size: 400% 400%;
      animation: gradientFlow 20s ease infinite alternate;
      font-family: 'Satoshi', sans-serif;
      margin: 0; padding: 20px; min-height: 100vh; color: var(--text-color);
    }

    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--card-border);
      box-shadow: 0 8px 32px var(--shadow-light);
    }

    .navbar {
      padding: 0.8rem 1.5rem; margin-bottom: 2rem; display: flex; gap: 1.5rem;
      position: sticky; top: 20px; z-index: 100; border-radius: 20px;
    }

    .site-title { font-size: 1.8rem; margin: 0; color: var(--text-color); font-weight: 700; }

    .nav-links { display: flex; gap: 1.2rem; flex-grow: 1; justify-content: center; }
    .nav-links a {
      color: var(--text-color); text-decoration: none; padding: 0.6rem 1.2rem;
      border-radius: 10px; font-weight: 500;
    }
    .nav-links a.active { background: var(--primary-color); color: white !important; }

    .search-container { max-width: 400px; width: 100%; flex-grow: 1; }
    .search-input {
      width: 100%; padding: 0.8rem 1.5rem; border: none; border-radius: 30px;
      background: var(--glass-bg); font-family: 'Satoshi', sans-serif; color: var(--text-color);
    }

    .anime-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 2rem; padding: 1.5rem; margin-bottom: 80px;
    }

    .anime-card {
      border-radius: 20px; padding: 1rem; position: relative; overflow: hidden;
      cursor: pointer; transition: transform 0.3s ease;
      filter: drop-shadow(0 10px 20px var(--shadow-light));
    }
    .anime-card:hover {
      transform: translateY(-8px);
      filter: drop-shadow(0 15px 30px var(--shadow-hover));
    }

    .anime-image {
      width: 100%; height: 300px; border-radius: 15px; object-fit: cover;
      border: 2px solid white; transition: transform 0.3s ease;
    }
    .anime-card:hover .anime-image { transform: scale(1.03); }

    .category-bubbles { position: absolute; top: 12px; left: 12px; display: flex; gap: 6px; z-index: 2; }
    .category-bubble {
      background: white; padding: 0.3rem 0.8rem; border-radius: 20px;
      font-size: 0.72rem; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .anime-title {
      text-align: center; margin: 1rem 0; font-size: 1.25rem; font-weight: 700;
    }

    .anime-description {
      background: rgba(255, 255, 255, 0.85); padding: 1rem; border-radius: 8px; margin-top: 1rem;
      font-family: 'Satoshi', sans-serif; font-size: 0.92rem; line-height: 1.5;
    }
    @media (prefers-color-scheme: dark) {
      .anime-description { background: rgba(20, 20, 30, 0.75); color: #e0e0e0; }
    }

    .favorite-icon {
      position: absolute; top: 12px; right: 12px; cursor: pointer; font-size: 1.6rem;
      color: #ff6b6b; z-index: 3;
    }
    .favorite-icon.active { color: #ff0000; }

    .back-to-top {
      position: fixed; bottom: 30px; right: 30px; background: var(--primary-color);
      color: white; width: 52px; height: 52px; border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center; opacity: 0;
      transition: opacity 0.3s ease; z-index: 1000;
    }
    .back-to-top.show { opacity: 1; }

    .menu-toggle { display: none !important; }
    @media (max-width: 768px) {
      .menu-toggle { display: flex !important; }
      .anime-grid { grid-template-columns: 1fr; }
    }

    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
  </style>
</head>
<body>
  <nav class="navbar glass">
    <h1 class="site-title">Remastersanime4k</h1>
    <button class="menu-toggle">☰</button>
    <div class="nav-links">
      <a href="#home" class="active">Inicio</a>
      <a href="#anime">Anime</a>
      <a href="#manga">Mangas</a>
      <a href="#favorites">Favoritos</a>
    </div>
    <div class="search-container">
      <input type="text" class="search-input" placeholder="Buscar...">
    </div>
  </nav>

  <div class="loading" style="display:none; text-align:center; grid-column:1/-1;">Cargando...</div>
  <div class="anime-grid"></div>
  <button class="back-to-top">↑</button>

  <script>
    let currentCategory = 'home';
    let searchTerm = '';
    let animeData = [];

    // ✅ FUNCIÓN CLAVE: limpia URLs
    function cleanUrl(url) {
      return (url || '').trim();
    }

    async function loadAnimeData() {
      try {
        const res = await fetch('animeData.json');
        if (!res.ok) throw new Error('No se pudo cargar animeData.json');
        return await res.json();
      } catch (e) {
        console.error(e);
        document.querySelector('.anime-grid').innerHTML = `<p style="grid-column:1/-1;text-align:center;color:var(--text-color)">Error al cargar datos.</p>`;
        return [];
      }
    }

    function toggleFavorite(title) {
      const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
      const idx = favs.indexOf(title);
      if (idx === -1) favs.push(title);
      else favs.splice(idx, 1);
      localStorage.setItem('favorites', JSON.stringify(favs));
      updateFavoriteIcons();
    }

    function updateFavoriteIcons() {
      const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
      document.querySelectorAll('.favorite-icon').forEach(icon => {
        const title = icon.dataset.title;
        icon.classList.toggle('active', favs.includes(title));
      });
    }

    function generateCards(data) {
      const grid = document.querySelector('.anime-grid');
      grid.innerHTML = '';
      data.forEach((item, i) => {
        // ✅ LIMPIEZA DE URLs
        const img = cleanUrl(item.image);
        const url = cleanUrl(item.url);
        const title = item.title || 'Sin título';
        const desc = item.description || '';
        const cats = item.categories || [];

        const card = document.createElement('div');
        card.className = 'anime-card glass';
        card.dataset.link = url;
        card.innerHTML = `
          <div class="favorite-icon" data-title="${title}" onclick="toggleFavorite('${title.replace(/'/g, "\\'")}')" role="button">♥</div>
          <div class="category-bubbles">
            ${cats.map(cat => `<div class="category-bubble">${cat.toUpperCase()}</div>`).join('')}
          </div>
          <img src="${img}" 
               alt="Portada de ${title}" 
               class="anime-image"
               loading="lazy"
               onerror="this.src='https://via.placeholder.com/300x400?text=No+disponible'">
          <h3 class="anime-title">${title}</h3>
          <div class="anime-description"><p>${desc}</p></div>
        `;
        grid.appendChild(card);
      });
      updateFavoriteIcons();
    }

    function filterCards() {
      if (!animeData.length) return;
      let filtered = animeData.filter(item => {
        const matchesCat = currentCategory === 'home' || (item.categories || []).includes(currentCategory);
        const matchesSearch = item.title.toLowerCase().includes(searchTerm.toLowerCase());
        return matchesCat && matchesSearch;
      });
      if (currentCategory === 'favorites') {
        const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
        filtered = animeData.filter(item => 
          favs.includes(item.title) && 
          item.title.toLowerCase().includes(searchTerm.toLowerCase())
        );
      }
      generateCards(filtered);
    }

    // Eventos básicos (simplificados)
    document.querySelector('.search-input').addEventListener('input', e => {
      searchTerm = e.target.value.trim();
      filterCards();
    });

    document.querySelector('.anime-grid').addEventListener('click', e => {
      const card = e.target.closest('.anime-card');
      if (card && !e.target.closest('.favorite-icon')) {
        window.open(card.dataset.link, '_blank', 'noopener,noreferrer');
      }
    });

    // Inicialización
    document.addEventListener('DOMContentLoaded', async () => {
      animeData = await loadAnimeData();
      filterCards();
    });
  </script>
</body>
</html>
